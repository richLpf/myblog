(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{482:function(s,n,a){"use strict";a.r(n);var e=a(30),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("日志对于项目来说也是很重要的一部分，毕竟我们的程序是不可能没有bug的。如果日志打印在项目中，会比较零散，不方便管理，也不方便收集。这里记录下我的一些做法。")]),s._v(" "),a("h2",{attrs:{id:"一、打印日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、打印日志"}},[s._v("#")]),s._v(" 一、打印日志")]),s._v(" "),a("p",[s._v("打印日志主要在两个地方，请求参数和返回参数，这样出现问题，基本就可以排除90%的问题了。")]),s._v(" "),a("p",[s._v("接着上一篇的文章结构")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("|-application             服务相关的逻辑\n|   |--run.go\n|-common                  公用函数\n|   |--utils.go\n|   |--request.go\n|-config                  配置\n|-dbs                     加载数据库\n|-docs                    swagger生成文档\n|-middleware              中间件\n|   |--cors.go            跨域处理中间件\n|   |--requestLog.go      打印请求日志中间件\n|-model                   模型\n|   |--passage.go         文章模型列表\n|   |--user.go\n|-controller              控制器\n|   |--user               用户相关接口\n|     |--user.go\n|   |--passage            文章相关接口\n|     |--passage.go\n|-router                  路由文件\n|   |--router.go  \n|—go.mod                  mod管理器\n|—go.sum                  自动生成记录包的版本\n|—main.go                 main包，入口文件\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("get请求参数，我们可以直接通过url拿到")]),s._v(" "),a("p",[s._v("我们写一个post请求接口，打印参数")]),s._v(" "),a("p",[a("code",[s._v("model/passage.go")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('type Passage struct {\n\tID         int       `json:"id"`\n\tTitle      string    `json:"title"`\n\tContent    string    `json:"content"`\n\tCreatedBy  string    `json:"created_by"`\n\tCreastedAt time.Time `json:"created_at"`\n\tUpdatedAt  time.Time `json:"updated_at"`\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("code",[s._v("controller/passage.go")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('type ReqPassage struct {\n\tID         int       `json:"id"` //id 0 表示新增  不为0表示编辑\n\tTitle      string    `json:"title"` //标题\n\tContent    string    `json:"content"` //内容\n\tCreatedBy  string    `json:"created_by"` //创建人\n\tUpdatedBy  string    `json:"updated_at"` //更新人\n}\nfunc AddPassage(c *gin.Context){\n\tvar req \n\tc.BindJSON()\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[a("code",[s._v("cat controller/passage.go")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("func AddPassage(c *gin.Context) {\n\tvar req model.ReqPassage\n\tif err := c.BindJSON(&req); err != nil {\n\t\tresponse.FailResponse(401, err.Error(), c)\n\t\treturn\n\t}\n\tpassage := model.Passage{\n\t\tID:      req.ID,\n\t\tTitle:   req.Title,\n\t\tContent: req.Content,\n\t}\n\tif err := services.NewPassage(passage); err != nil {\n\t\tresponse.FailResponse(401, err.Error(), c)\n\t\treturn\n\t}\n\tresponse.SuccessResponse(nil, c)\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[a("code",[s._v("cat services/passage.go")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//NewPassage passage\nfunc NewPassage(req model.Passage) error {\n\treturn dbs.DB.Save(&req).Error\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("上面我们写了一个添加文章的post接口，")]),s._v(" "),a("p",[a("img",{attrs:{src:"C:%5CUsers%5Cuser%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1589423322308.png",alt:"1589423322308"}})]),s._v(" "),a("p",[s._v("我们调用一下，发现返回了bindJSON返回了EOF,这是因为gin，bindJSON方法只允许解析一次参数，第二次解析就会失败，解决办法如下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('//RequestLogs 打印请求日志中间件\nfunc RequestLogs() gin.HandlerFunc {\n\treturn func(c *gin.Context) {\n\t\tmethod := c.Request.Method\n\t\tfmt.Println("header", c.Request)  //打印header信息\n\t\tif method == "POST" || method == "PUT" {\n\t\t\tbuf := &bytes.Buffer{}  \n\t\t\ttea := io.TeeReader(c.Request.Body, buf)\n\t\t\tbody, err := ioutil.ReadAll(tea)\n\t\t\tif err != nil {\n\t\t\t\tlog.Panicf("read body err: %+v", err)\n\t\t\t}\n\t\t\tc.Request.Body = ioutil.NopCloser(buf)\n\t\t\tvar params interface{}\n\t\t\tif err := binding.JSON.BindBody(body, &params); err != nil {\n\t\t\t\tfmt.Println("params err", params)\n\t\t\t}\n\t\t\tfmt.Println("request", params)\n\t\t}\n\t\tc.Next()\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("通过上面中间件，就可以正常再次解析请求参数")]),s._v(" "),a("p",[a("img",{attrs:{src:"C:%5CUsers%5Cuser%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1589425069463.png",alt:"1589425069463"}})]),s._v(" "),a("p",[s._v("我们可以看到文章插入成功，并且日志也成功打印。")]),s._v(" "),a("p",[s._v("我们还可以将日志以json方式打印，这样增加可读性，并且可以用logstash收集日志，分析日志")]),s._v(" "),a("h2",{attrs:{id:"二、定时清理访问日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、定时清理访问日志"}},[s._v("#")]),s._v(" 二、定时清理访问日志")]),s._v(" "),a("p",[s._v("如果这样操作当然会出现其他问题，日志文件增加很快，服务器磁盘很快就满了，日志查询也很费劲")]),s._v(" "),a("h3",{attrs:{id:"_1、要增加告警"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、要增加告警"}},[s._v("#")]),s._v(" 1、要增加告警")]),s._v(" "),a("p",[s._v("执行语句：查看系统内存使用情况")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("df -P | grep /dev | awk '{print $5}' \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"C:%5CUsers%5Cuser%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1589683444385.png",alt:"1589683444385"}})]),s._v(" "),a("p",[s._v("shell脚本：定时获取")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#*************************************************************************\n#  FileName     :               alarm.sh \n#*************************************************************************\n#  Author       :               pengfei.lv\n#  CreateDate   :               2020-05-16\n#  Description  :               this script is mointoring the linux disk\n#                               capacity, if disk used more than 90%, then notice\n#*************************************************************************\n\n\n#!/bin/bash\n# 读取磁盘空间使用情况\nfor d in `df -P | grep /dev | awk '{print $5}' | sed 's/%//g'`\ndo\n  if [ $d -gt 90 ]; then\n    echo \"内存使用大小$d\"\n    echo \"当内容空间使用率大于90,告警通知,邮件，企业微信，短信。。。\"\n    exit 0;\n  fi\ndone\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("增加定时脚本，每隔10分钟运行一次")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("*/10 * * * * /alarm/alarm.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_2、每天自动切割日志-并清理7天以上日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、每天自动切割日志-并清理7天以上日志"}},[s._v("#")]),s._v(" 2、每天自动切割日志,并清理7天以上日志")]),s._v(" "),a("p",[s._v("具体做法")]),s._v(" "),a("p",[s._v("（1）获取当前的日志")]),s._v(" "),a("p",[s._v("（2）将本来的日志按照时间命名复制一份")]),s._v(" "),a("p",[s._v("（3）将原来的日志清空")]),s._v(" "),a("p",[s._v("（4）查找7天以上的日志，删除")]),s._v(" "),a("p",[s._v("清空日志一般使用："),a("code",[s._v("cat /dev/null > file.log")])]),s._v(" "),a("p",[s._v("xargs rm  传递删除命令给找到的文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# /bin/bash\n\nbase_path=\'/var/lib/logs/\'\necho $base_path\n\nday=`date \'+%Y%m%d\'`\necho $day\n# 先将本来的日志按时间命名复制一份\ncp $base_path"file.log" $base_path"log"$day".log"\n# 将原来的日志文件清空\ncat /dev/null > $base_path"file.log"\n\n\\# 清理7天以上的日志\nfind /var/lib/logs/ -name \'*.log\' -and -mtime +7 -type f |xargs rm\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("这里提供了清理日志的脚本，也可以改造下，如果日志比较重要，可以增加日志存在的时间或者将日志迁移到一台单独的机器存储和分析。具体情况根据你的业务场景来确定。")])])}),[],!1,null,null,null);n.default=t.exports}}]);