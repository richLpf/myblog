(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{483:function(s,n,e){"use strict";e.r(n);var a=e(30),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"企业微信开发整理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#企业微信开发整理"}},[s._v("#")]),s._v(" 企业微信开发整理")]),s._v(" "),e("p",[s._v("服务端API "),e("code",[s._v("https://work.weixin.qq.com/api/doc/90000/90135/90664")])]),s._v(" "),e("p",[s._v("详细代码见 "),e("code",[s._v("wechat.go")])]),s._v(" "),e("p",{attrs:{align:"center"}},[e("img",{attrs:{src:"http://weblpf.cn-bj.ufileos.com/ufile-log%2Fweblpf%2F%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91.png",width:"500"}})]),s._v(" "),e("blockquote",[e("p",[s._v("企业微信开发分为服务端API和客户端API")])]),s._v(" "),e("p",[s._v("一、企业微信开发前需要了解几个问题")]),s._v(" "),e("p",[s._v("默认你已经知道了下面的问题")]),s._v(" "),e("p",[s._v("1、企业微信开发，一般对应的是创建相关应用（这里创建应用取名：优效）")]),s._v(" "),e("p",[s._v("2、"),e("img",{attrs:{src:"https://work.weixin.qq.com/api/doc/90000/90135/90665",alt:"微信的后台获取的参数"}})]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("corpid\nuserid\n部门id\ntagid\nagentid\nsecret\naccess_token\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("3、这里的开发主要是三个地方的处理")]),s._v(" "),e("ul",[e("li",[s._v("获取access_token")]),s._v(" "),e("li",[s._v("身份验证-网页授权登录")]),s._v(" "),e("li",[s._v("消息推送")])]),s._v(" "),e("p",[s._v("二、获取access_token")]),s._v(" "),e("p",[s._v("调用企业微信接口首先需要获取access_token，获取access_token的方法很简单")]),s._v(" "),e("p",[s._v("1、首先在企业微信后台获取企业微信的企业微信ID(corpid)和应用的密钥(Secret)")]),s._v(" "),e("p",[s._v("2、调用企业微信接口")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=ID&corpsecret=SECRET\n\n返回参数：\n{\n   "errcode": 0,\n   "errmsg": "ok",\n   "access_token": "accesstoken000001",\n   "expires_in": 7200\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("3、缓存access_token")]),s._v(" "),e("p",[s._v("定义两个全局变量，一个用来存放access_token,一个用来存放access_token失效时间")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("GLOBALTOKEN 存放access_token\nGLOBALEXPIRE 存放access_token失效时间\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("获取access_token")]),s._v(" "),e("li",[s._v("查询GLOBALTOKEN是否有值，无值直接调用接口获取，若有值")]),s._v(" "),e("li",[s._v("通过GLOBALEXPIRE是否失效，有效则直接返回，无效则调用接口获取")])]),s._v(" "),e("p",[s._v("三、网页授权登录")]),s._v(" "),e("p",[s._v("很多时候，我们需要在手机端查看信息，开发自己的页面展示，如果每次都登录太麻烦，可以直接调用企业微信接口获取用户信息，在再此之前需要通过认证")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("参数")]),s._v(" "),e("th",[s._v("必须")]),s._v(" "),e("th",[s._v("说明")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("appid")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("企业的CorpID")])]),s._v(" "),e("tr",[e("td",[s._v("redirect_uri")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("授权后重定向的回调链接地址，请使用urlencode对链接进行处理")])]),s._v(" "),e("tr",[e("td",[s._v("response_type")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("返回类型，此时固定为：code")])]),s._v(" "),e("tr",[e("td",[s._v("scope")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("应用授权作用域。企业自建应用固定填写：snsapi_base")])]),s._v(" "),e("tr",[e("td",[s._v("state")]),s._v(" "),e("td",[s._v("否")]),s._v(" "),e("td",[s._v("重定向后会带上state参数，企业可以填写a-zA-Z0-9的参数值，长度不可超过128个字节")])]),s._v(" "),e("tr",[e("td",[s._v("#wechat_redirect")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("终端使用此参数判断是否需要带上身份信息")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("假定当前\n企业CorpID：wxCorpId\n访问链接：http://api.3dept.com/cgi-bin/query?action=get\n根据URL规范，将上述参数分别进行UrlEncode，得到拼接的OAuth2链接为：\nhttps://open.weixin.qq.com/connect/oauth2/authorize?appid=wxCorpId&redirect_uri=http%3a%2f%2fapi.3dept.com%2fcgi-bin%2fquery%3faction%3dget&response_type=code&scope=snsapi_base&state=#wechat_redirect\n员工点击后，页面将跳转至 \nhttp://api.3dept.com/cgi-bin/query?action=get&code=AAAAAAgG333qs9EdaPbCAP1VaOrjuNkiAZHTWgaWsZQ&state=\n企业可根据code参数调用获得员工的userid\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("blockquote",[e("p",[s._v("注意到，构造OAuth2链接中参数的redirect_uri是经过UrlEncode的")])]),s._v(" "),e("p",[s._v("通过构造OAuth2链接，可以进行微信认证，拿到code就可以获取用户信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// access_token 第二步获取的access_token\n// code 第三步获取的code,code有效期为5分钟，只能使用一次\nhttps://qyapi.weixin.qq.com/cgi-bin/user/getuserinfo?access_token=ACCESS_TOKEN&code=CODE\n\n{\n   "errcode": 0,\n   "errmsg": "ok",\n   "UserId":"USERID",\n   "DeviceId":"DEVICEID"\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("获取userid后，在调用读取成员信息接口")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=ACCESS_TOKEN&userid=USERID\n\n// 返回的信息（展示部分）\n{\n    "errcode": 0,\n    "errmsg": "ok",\n    "userid": "zhangsan",\n    "name": "李四",\n    "department": [1, 2],\n    "order": [1, 2],\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("注意：上面如果每次打开企业微信，重定向获取code会有时间的消耗，而且转发、刷新后会导致页面获取用户信息失败，最好进行下面的处理")]),s._v(" "),e("p",[s._v("1、前端拿到code后，返回给后端，后端返回用户信息、cookies信息和有效期（服务端设置），前端缓存在本地，作为用户登录的凭证\n2、前端直接使用自己页面的链接，如果没有cookies信息，在前端重定向到认证页面，获取code,调用接口，缓存信息\n3、获取用户信息，登录页面")]),s._v(" "),e("p",[s._v("这样处理就比较灵活，可以跟据页面设置有效期，页面的打开速度也会快了很多。")]),s._v(" "),e("p",[s._v("四、推送信息")]),s._v(" "),e("p",[s._v("企业微信支持的消息类型有")]),s._v(" "),e("ul",[e("li",[s._v("文本消息")]),s._v(" "),e("li",[s._v("图片消息")]),s._v(" "),e("li",[s._v("语音消息")]),s._v(" "),e("li",[s._v("视频消息")]),s._v(" "),e("li",[s._v("文件消息")]),s._v(" "),e("li",[s._v("文本卡片消息")]),s._v(" "),e("li",[s._v("图文消息")]),s._v(" "),e("li",[s._v("图文消息（mpnews）")]),s._v(" "),e("li",[s._v("markdown消息")]),s._v(" "),e("li",[s._v("小程序通知消息")]),s._v(" "),e("li",[s._v("任务卡片消息")])]),s._v(" "),e("p",[s._v("1、推送信息给个人")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=ACCESS_TOKEN\n\n对应的请求参数，不通类型不通可以通过企业微信查看(https://work.weixin.qq.com/api/doc/90000/90135/90236)\n\n// 返回参数\n {\n   "errcode" : 0,\n   "errmsg" : "ok",\n   "invaliduser" : "userid1|userid2",\n   "invalidparty" : "partyid1|partyid2",\n   "invalidtag": "tagid1|tagid2"\n }\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("如果所有的用户不存在，才会返回失败，部分不存在会提示在invaliduser字段中")]),s._v(" "),e("p",[s._v("2、推送信息给群聊")]),s._v(" "),e("p",[s._v("企业微信必须通过api创建群聊，然后才能进行推送")]),s._v(" "),e("p",[s._v("创建群聊：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('https://qyapi.weixin.qq.com/cgi-bin/appchat/create?access_token=ACCESS_TOKEN\n\n//请求参数\n{\n    "name" : "NAME",\n    "owner" : "userid1",\n    "userlist" : ["userid1", "userid2", "userid3"],\n    "chatid" : "CHATID"\n}\n\n//返回参数\n{\n    "errcode" : 0,\n    "errmsg" : "ok",\n    "chatid" : "CHATID"\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("table",[e("thead",[e("tr",[e("th",[s._v("参数")]),s._v(" "),e("th",[s._v("是否必须")]),s._v(" "),e("th",[s._v("说明")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("access_token")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("调用接口凭证")])]),s._v(" "),e("tr",[e("td",[s._v("name")]),s._v(" "),e("td",[s._v("否")]),s._v(" "),e("td",[s._v("群聊名，最多50个utf8字符，超过将截断")])]),s._v(" "),e("tr",[e("td",[s._v("owner")]),s._v(" "),e("td",[s._v("否")]),s._v(" "),e("td",[s._v("指定群主的id。如果不指定，系统会随机从userlist中选一人作为群主")])]),s._v(" "),e("tr",[e("td",[s._v("userlist")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("群成员id列表。至少2人，至多2000人")])]),s._v(" "),e("tr",[e("td",[s._v("chatid")]),s._v(" "),e("td",[s._v("否")]),s._v(" "),e("td",[s._v("群聊的唯一标志，不能与已有的群重复；字符串类型，最长32个字符。只允许字符0-9及字母a-zA-Z。如果不填，系统会随机生成群id")])])])]),s._v(" "),e("p",[s._v("推送群聊信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('https://qyapi.weixin.qq.com/cgi-bin/appchat/send?access_token=ACCESS_TOKEN\n\n//对应的请求参数，不通类型不通可以通过企业微信查看(https://work.weixin.qq.com/api/doc/90000/90135/90248)\n\n{\n    "chatid": "CHATID",\n    "msgtype":"text",\n    "text":{\n        "content" : "你的快递已到\\n请携带工卡前往邮件中心领取"\n    },\n    "safe":0\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);